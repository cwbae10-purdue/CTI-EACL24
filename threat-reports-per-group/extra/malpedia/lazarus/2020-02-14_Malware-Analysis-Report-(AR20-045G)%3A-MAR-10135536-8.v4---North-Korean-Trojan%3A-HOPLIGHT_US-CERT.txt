An official website of the United States government Here's how you know
This report is provided "as is" for informational purposes only.
The Department of Homeland Security (DHS) does not provide any warranties of any kind regarding any information contained herein.
The DHS does not endorse any commercial product or service referenced in this bulletin or otherwise.
This document is marked TLP:WHITE--Disclosure is not limited.
Sources may use TLP:WHITE when information carries minimal or no foreseeable risk of misuse, in accordance with applicable rules and procedures for public release.
Subject to standard copyright rules, TLP:WHITE information may be distributed without restriction.
For more information on the Traffic Light Protocol (TLP), see http://www.us-cert.gov/tlp.
This Malware Analysis Report (MAR) is the result of analytic efforts between Department of Homeland Security (DHS), the Federal Bureau of Investigation (FBI), and the Department of Defense (DoD).
Working with U.S. Government partners, DHS, FBI, and DoD identified Trojan malware variants used by the North Korean government.
This malware variant has been identified as HOPLIGHT.
The U.S. Government refers to malicious cyber activity by the North Korean government as HIDDEN COBRA.
For more information on HIDDEN COBRA activity, visit https[:]//www[.]us-cert.gov/hiddencobra.
DHS, FBI, and DoD are distributing this MAR to enable network defense and reduce exposure to North Korean government malicious cyber activity.
This MAR includes malware descriptions related to HIDDEN COBRA, suggested response actions and recommended mitigation techniques.
Users or administrators should flag activity associated with the malware and report the activity to the Cybersecurity and Infrastructure Security Agency (CISA) or the FBI Cyber Watch (CyWatch), and give the activity the highest priority for enhanced mitigation.
This report provides analysis of twenty malicious executable files.
Sixteen of these files are proxy applications that mask traffic between the malware and the remote operators.
The proxies have the ability to generate fake TLS handshake sessions using valid public SSL certificates, disguising network connections with remote malicious actors.
One file contains a public SSL certificate and the payload of the file appears to be encoded with a password or key.
The remaining file does not contain any of the public SSL certificates, but attempts outbound connections and drops four files.
The dropped files primarily contain IP addresses and SSL certificates.
For a downloadable copy of IOCs, see MAR-10135536-8.v4.stix.
This artifact is a malicious 32-bit Windows executable.
When executed the malware will collect system information about the victim machine including OS Version, Volume Information, and System Time, as well as enumerate the system drives and partitions.
Both are nearly identical in functionality but use slightly different command codes.
So if the opcode for Keepalive in version 1 is 0xB6C1, the opcode in version 2 will be 0xB6C2.
Keys are decrypted prior to calling RegOpenKey/RegQueryValue.
C2 specifies the path of the file to be run via command line.
0xB6AA EnableLogging
			   -Prior to victim and C2 closing out a connection the victim will spawn a new thread that will compile a comprehensive log of system/session information.
Inside this thread it opens a file that is named randomly and places it in the temp directory.
It puts all the log results into this file.
0xB6AB Deletefile
			   -Deletes file specified by the C2.
0xB6AC RunCmdPipe
			   -Runs CreateProcessW to run a process via the command line.
The process will be cmd.exe and the arguments will be the windows cmd command that the C2 specifies.
The results of this command will be sent to a temporary file and then read back to the C2 from that file.
Afterwards that file is deleted.
0xB6AD Processlist
			   -Gets a list of processes
			0xB6AE KillProcess
			   -Kills process based on the PID that the C2 supplies.
0xB6AF TestEncryption
			   -Tests LFSR encryption, no real functionality
			0xB6B0 Uninstall
			   -Uninstalls the implant from the victim box
			0xB6B2 GetConfig
			   -Gets the current callback config file from memory, returns the list to C2.
There are 10 IP options in this config.
0xB6B3 SetConfig
			   -Gets the current callback config file from memory, allows C2 to change the configurations.
This will change the beacon IP to whatever the C2 wants.
The malware uses a public SSL certificate for secure communication.
This certificate is from www.naver.com.
Naver.com is the largest search engine in Korea and provides a variety of web services to clients around the world.
The malware uses the default certificates/private keys that come with PolarSSL.
These are generally used for testing purposes only.
Additionally the C2 IPs that act as the server for the TLS handshake require the malware to respond back with a client key.
This key is also a default key found within the PolarSSL libraries.
These IP addresses are referenced in 'udbcgiut.dat' below.
The malware also contains an embedded Zlib compression library that appears to further obfuscate the communications payload.
After the TLS authentication is completed this particular malware does NOT use the session key that is generated via TLS.
It uses a custom Linear Feedback Shift Register (LFSR) encryption scheme to encrypt all communications after the completion of the handshake.
Therefore, only capability that is unique will be described for the following four artifacts.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When this artifact is executed, it will write the file 'udbcgiut.dat' to C:\Users\<user>\AppData\Local\Temp.
The malware will then attempt outbound SSL connections to 81.94.192.147 and 112.175.92.57.
Both connection attempts are over TCP Port 443.
The two IP addresses above, as well as the IP addresses 181.39.135.126 and 197.211.212.59 are hard-coded into the malware.
However, only connections to the first two IP addresses were attempted during analysis.
This IP address is listed in the file 'udbcgiut.dat'.
Outbound SSL connection attempts are made to this IP by Malware2.exe, Malware3.exe, and Malware5.exe.
The domain, zol-ad-bdc.zol.co.zw is associated with the IP address, however, no DNS query is made for the name.
inetnum:     181.39.135.120/29
			status:     reallocated
			owner:     Clientes Guayaquil
			ownerid:     EC-CLGU1-LACNIC
			responsible: Tomislav Topic
			address:     Kennedy Norte Mz.
This IP address is listed in the file 'udbcgiut.dat'.
Outbound SSL connection attempts are made to this IP by Malware2.exe, Malware3.exe, and Malware5.exe.
No domain is associated with the IP address.
This IP address is listed in the file 'udbcgiut.dat'.
Outbound SSL connection attempts are made to this IP by Malware2.exe, Malware3.exe, and Malware5.exe.
The domain, mail.everzone.co.kr is associated with the IP address, however, no DNS query is made for the name.
This IP address is listed in the file 'udbcgiut.dat'.
Outbound SSL connection attempts are made to this IP by Malware2.exe, Malware3.exe, and Malware5.exe.
No domain is associated with the IP address.
'udbcgiut.dat' is dropped by three of the four PE32 executables.
This file contains a 32byte unicode string uniquely generated for the infected system, as well as four socket pairs in hexidecimal.
---Begin Decoded Socket Pairs---
			197.211.212.59:443
			181.39.135.126:443
			112.175.92.57:7443
			81.94.192.147:7443
			---End Decoded Socket Pairs---
			The unicode string generated during this analysis was '8a9b11762b96c4b6'.
The socket pairs remain the same for all instances of the malware.
For the PE32 executables, 'udbcgiut.dat' was dropped in the victim's profile at %AppData%\Local\Temp.
For the 64bit executables, 'udbcgiut.dat' was dropped in C:\Windows.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
This artifact appears to be named 'lamp.exe'.
The malware contains the following debug pathway:
			---Begin Debug Pathway---
			Z:\Develop\41.LampExe\Release\LampExe.pdb
			---End Debug Pathway---
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
This program attempts to initiate a TLS Handshake to the four IP/Port pairs listed in 'udbcgiut.dat'.
If the program is unable to establish a connection, the file 'udbcgiut.dat' is deleted.
After 'udbcgiut.dat' is deleted, an outbound SSL connection is made to 81.94.192.10.
The IP address is hard coded in the malware and are not randomly generated.
This artifact also loads several APIs that are commonly associated with Pass-The-Hash (PTH) toolkits, indicating a capability to harvest user credentials and passwords.
---Begin Common PTH APIs---
			SamiChangePasswordUser
			SamFreeMemory
			SamCloseHandle
			SamOpenUser
			SamLookupNamesInDomain
			SamOpenDomain
			SamConnect
			---End Common PTH APIs---
A high port to high port connection attempt is made to this IP address from 'Malware5.dll'.
No domain is associated with the IP address.
This artifact is a malicious x64 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
In addition to the capabilities described above, this variant will hook the Windows Local Security Authority (lsass.exe).
'lsass.exe' will check the registry for the data value 'rdpproto' under the key SYSTEM\CurrentControlSet\Control\Lsa Name: Security Packages.
If not found, this value is added by 'lsass.exe'.
Next, the malware will drop the embedded file, 'rdpproto.dll' into the %System32% directory.
The file, 'udbcgiut.dat' is then written to C:\Windows.
Outbound connection attempts are made to the socket pairs found within this file as described above.
"rdpproto.dll" is dropped into the %System32% directory by 868036E102DF4CE414B0E6700825B319.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
A high port to high port connection attempt is made to this IP address from 'Malware2.dll'.
No domain is associated with the IP address.
This artifact is a malicious 64bit Windows dynamic library called 'Vote_Controller.dll'.
The file shares similar functionality with 'rdpproto.dll' above, and attempts to connect to the same ten IP addresses.
42682D4A78FE5C2EDA988185A344637D also contains the same public SSL certificate as many of the artifacts above.
This artifact is 64bit Windows dynamic library file which shares many of the same characteristics and name (Vote_Controller.dll) as 42682D4A78FE5C2EDA988185A344637D above.
When this library is loaded it will look for the file 'udbcgiut.dat' in C:\WINDOWS.
If 'udbcgiut.dat' is not found, the file will attempt connections to the same ten IP addresses described under 'rdpproto.dll' above.
One notable difference with this variant is that it uses the Windows Management Instrumentation (WMI) process to recompile the Managed Object Format (MOF) files in the WMI repository.
At runtime, the malware will enumerate the drivers located in the registry at HKLM\Software\WBEM\WDM.
These files are then recompiled by invoking wmiprvse.exe through svchost.exe: "C:\Windows\system32\wbem\wmiprvse.exe -Embedding".
MOF files are written in a SQL-like language and are run (compiled) by the operating system when a predetermined event takes place.
Recent malware variants have been observed modifying the MOF files within the system registry to run specific commands and create persistency on the system.
Of note, the paravirtual SCSI driver for VMWare Tools is also located in HKLM\Software\WBEM\WDM within a virtual image.
When this driver is recompiled by the malware, VMWare Tools no longer works.
It cannot be determined if this is an intentional characteristic of the malware to hinder analysis, or simply a symptom of the method used to establish persistence.
This artifact is a malicious PE32 executable.
When executed, the artifact sets up the service, 'Network UDP Trace Management Service'.
To set up the service, the program drops a dynamic library, 'UDPTrcSvc.dll' into the %System32% directory.
After writing 'UDPTrcSvd.dll' to disk, the program drops two additional files.
Similar to 5C3898AC7670DA30CF0B22075F3E8ED6 above, the program writes the file 'udbcgiut.dat' to the victim's profile at %AppData/Local/Temp%.
A second file is written to the victim's profile in the %AppData/Local/VirtualStore/Windows% directory and identified as 'MSDFMAPI.INI'.
'MSDFMAPI.INI' is also written to C:\WINDOWS.
More information on the content of these files is below.
61E3571B8D9B2E9CCFADC3DDE10FB6E1 attempts the same outbound connections as 5C3898AC7670DA30CF0B22075F3E8ED6, however the file does not contain any of the public SSL certificates referenced above.
This artifact is a malicious 32bit Windows dynamic library.
'UDPTrcSvc.dll' is identified as the 'Network UDP Trace Management Service'.
The following description is provided:
			---Begin Service Description---
			Network UDP Trace Management Service Hosts TourSvc Tracing.
If this service is stopped, notifications of network trace will no longer function and there might not be access to service functions.
If this service is disabled, notifications of and monitoring to network state will no longer function.
---End Service Description---
			The service is invoked with the command, 'C:\Windows\System32\svchost.exe -k mdnetuse'.
When the service is run a modification to the system firewall is attempted, 'cmd.exe /c netsh firewall add portopening TCP 0 "adp"'.
Unlike many of the files listed above that use a public certificate from naver.com, 'UDPTrcSvc.dll' uses a public SSL certificate from google.com.
'MSDFMAPI.INI' is written to C:\WINDOWS and to %UserProfile\AppData\Local\VirtualStore\Windows%.
During analysis, two NULL characters were written to the file.
The purpose of the file has not been determined.
This file containing two NULL bytes is benign.
This artifact contains a similar public SSL certificate from naver.com, similar to many of the files above.
The payload of the file appears to be encoded with a password or key.
No context was provided with the file's submission.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			--Begin IP List--
			117.239.241.2
			218.255.24.226
			195.158.234.60
			--End IP List--
			Client uses uk.yahoo.com for client hello server name instead of naver.com.
This artifact is a malicious 64bit Windows dynamic library.
When run the malware drops a Themida packed DLL.
This DLL runs and drops another DLL that acts as the Remote admin tool.
This RAT is very similar to version 2 in op codes and functionality however it uses real TLS instead of the LFSR encryption.
Additionally it encodes it's data with XOR Ox47 SUB Ox28 prior to being TLS encrypted.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
This file is dropped by a different binary into System32 and then run as a service.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			--Begin IP List--
			192.168.1.2
			--End IP List--
			Client uses uk.yahoo.com for client hello server name instead of naver.com.
This artifact is a malicious 64bit Windows dynamic library.
The DLL can be run using the DoStart export.
This export calls write file to load the actual implant into a file "C:\windows\msncone.exe" and then calls Win Exec to execute the implant.
This artifact is a malicious PE32 executable that is an add-on tool for other Hoplight implants.
When malware is run it opens a log file C:\WINDOWS\Temp\ndb.dat that is used for the remainder of the program to log all activity.
The malware runs with an IP as an argument.
It sends out a beacon to this IP and connects to it using the same FakeTLS/PolarSSL protocol as the other samples.
After a successful connection to a C2, it uses a named pipe called \\\\.\\pipe\\AnonymousPipe to connect to a running implant and sends tasking to the running implant.
The implant returns the results of these taskings over the named pipe and the malware sends the results back to the C2.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			--Begin IP List--
			10.10.30.130
			--End IP List--
			Client uses uk.yahoo.com for client hello server name instead of naver.com.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			--Begin IP List--
			218.255.24.226
			--End IP List--
			Client uses www.bing.com.
Microsoft.com, and facebook.com for client hello server name instead of naver.com.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
This file is dropped by a different binary into System32 and then run as a service.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			--Begin IP List--
			81.94.192.147
			112.175.92.57
			181.39.135.126
			197.211.212.59
			--End IP List--
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			---Begin IP List---
			14.140.116.172
			---End IP List---
			Client uses uk.yahoo.com for client hello server name instead of naver.com.
The file 34E56056E5741F33D823859E77235ED9 beacons to this hard coded IP.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hard coded IPs:
			---Begin IP List---
			210.137.6.37
			119.18.230.253
			221.138.17.152
			---End IP List---
			Client uses naver.com for client hello server name.
The file 2FF1688FE866EC2871169197F9D46936 beacons to this hard coded IP.
The file 2FF1688FE866EC2871169197F9D46936 beacons to this hard coded IP.
The file 2FF1688FE866EC2871169197F9D46936 beacons to this hard coded IP.
This artifact is a malicious PE32 executable with similar characteristics of those described in 23E27E5482E3F55BF828DAB885569033 above.
When the malware runs it checks a config file to determine where it should beacon back to.
If the config file has not been modified the malware will beacon back to the following hardcoded IPs.
--Begin Hardcoded IP--
			117.239.241.2
			217.117.4.110
			--End Hardcoded IP--
The file ba80cb0a08908782f4b6e88aa15e2d306b19bc93e79bd8770bf8be904fd1bd09 beacons to this hardcoded IP.
This executable must be run with argument 15975345682 to execute and then drops C:\Windows\system32\dispark.dll (E5D1C42E5CA7A0AC3A3B31BD0F290E84), a custom packed loader.
E5D1C42E5CA7A0AC3A3B31BD0F290E84 drops 535C879CA109DBECD336E1DE0ECCB696 that runs as a service.
This executable must be run with argument 15975345682 to execute and then drops C:\Windows\system32\diskpart.dll (7AFF84FB44840E4FD53CC9561172E14B), a custom packed loader.
7AFF84FB44840E4FD53CC9561172E14B drops BD674814315892B937BC91A10783D140 that runs as a service.
CISA recommends that users and administrators consider using the following best practices to strengthen the security posture of their organization's systems.
Any configuration changes should be reviewed by system owners and administrators prior to implementation to avoid unwanted impacts.
Additional information on malware incident prevention and handling can be found in National Institute of Standards and Technology (NIST) Special Publication 800-83, "Guide to Malware Incident Prevention & Handling for Desktops and Laptops".
CISA continuously strives to improve its products and services.
You can help by answering a very short series of questions about this product at the following URL: https://us-cert.gov/forms/feedback/
A Malware Initial Findings Report (MIFR) is intended to provide organizations with malware analysis in a timely manner.
In most instances this report will provide initial indicators for computer and network defense.
To request additional analysis, please contact CISA and provide information regarding the level of desired analysis.
A Malware Analysis Report (MAR) is intended to provide organizations with more detailed malware analysis acquired via manual reverse engineering.
To request additional analysis, please contact CISA and provide information regarding the level of desired analysis.
Can I edit this document?
This document is not to be edited in any way by recipients.
All comments or questions related to this document should be directed to the CISA at 1-888-282-0870 or soc@us-cert.gov.
Can I submit malware to CISA?
Malware samples can be submitted via three methods:
CISA encourages you to report any suspicious activity, including cybersecurity incidents, possible malicious code, software vulnerabilities, and phishing-related scams.
Reporting forms can be found on CISA's homepage at www.us-cert.gov.
This product is provided subject to this Notification and this Privacy & Use policy.
We recently updated our anonymous product survey; we'd welcome your feedback.
Receive security alerts, tips, and other updates.
CISA is part of the Department of Homeland Security
