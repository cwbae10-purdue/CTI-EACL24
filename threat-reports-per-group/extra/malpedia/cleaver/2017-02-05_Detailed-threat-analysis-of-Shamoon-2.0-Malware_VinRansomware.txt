Our Previous post talked about the initial overview of the Shamoon 2.0 sample.
This analysis is a continuation of our last post but with a more insight on the working and behavior of the malware.There are 3 components which are linked with one another which makeup Shamoon 2.0 single malware.
We have analyzed each component according to the stages which the Shamoon 2.0 uses for infection on a victim's machine i.e.
Dropper Component⇒ Communication Component⇒ Wiper Component.
When Shamoon 1.0 made its first wave of attack in August 2012, it had not just infected 30,000-35,000 computers but it also had crippled the entire organizations altogether which were infected with it.
One survey about the Middle East reports some of the facts mentioned below:
● More than 70 percent of the users  said that they were storing administrative passwords in plaintext.
● Over 45 percent of the users use the same password for over multiple systems.● More than 40 percent users share their passwords.● Only 13 percent users change their passwords once a month.
These facts make the Middle East region more easy as a target for Shamoon 2.0.
We have launched a Shamoon detection tool which can detect the new Shamoon 2.0.
Following below is the in-depth analysis that we have done on Shamoon 2.0.
Dropper Component - Disttrack:Upon computing the hash value of the sample, the SHA256 as 394a7ebad5dfc13d6c75945a61063470dc3b68f7a207613b79ef000e1990909bDoing a quick VirusTotal search we get the following output:
This assures us that the sample we are analyzing is of Shamoon 2.0.
The date of update also tells us that it is the recent Shamoon sample which is dubbed as the Shamoon 2.0.
The sample uses the following evasion techniques for Debugging:1)    GetLastError2)    IsDebuggerPresent3)    Process32FirstW4)    Process32NextW5)    TerminateProcess6)    UnhandledExceptionFilter
The following screenshot gives information of the which compiler was used for compiling the malware, which entry point address is being used, EP section tells us the entry point of the portable executable (PE).
 As mentioned earlier above the compiler used is Microsoft Visual C++ v8.0 2005
Malware in general use some basic techniques to obfuscate the code so that it is not easily readable when loaded in any debugger and to make it more difficult to reverse the malware.
There are many Hashing methods that can be used.
Our sample uses the Hash technique known as Base64.
We know that Shamoon 2.0 was targeted the Middle East region.
Registry Key-ReadHKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\WindowsNT\CurrentVersion\GRE_Initialize\DisableMetaFiles Communication Component - Disttrack:
Upon computing the hash value of the sample, the SHA256 as 61c1c8fc8b268127751ac565ed4abd6bdab8d2d0f2ff6074291b2d54b0228842, doing a quick VirusTotal search we verified the sample as a part of the Shamoon 2.0
Following screenshot shows that communication component has the same hash technique as that seen in the dropper component mentioned earlier, i.e.
HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Services\Tcpip\Parameters\DomainNameDevolutionLevelThese above results only indicate that the malware sample tries to communicate with the server.
The wiper component is the most important component out of the three components of Shamoon 2.0.
Upon computing the hash value of the sample, the SHA256 as 128fa5815c6fee68463b18051c1a1ccdf28c599ce321691686b1efa4838a2acd.A quick look up with VirusTotal confirms that this indeed is a wiper component of the Shamoon 2.0.
CryptEncrypt Function is also used.
Doing a VirusTotal lookup gives us the following confirmation that the software is malicious in nature and that the detection ratio is very low as well.
Now the preliminary analysis shows us the following files that were found:
During the analysis for the file we found the following device name parameters
The interesting thing is that, this same details were also found in the previous Shamoon attack that took place in 2012.
We also came across these ‘060523170051Z’ and ‘160523171051Z0W1’ strings.
The interesting thing about these numbers is that they are found in a different malware which has a file name ‘mimidrv.sys’.
The screenshot of that malware is mentioned below.
This malware mentioned above is basically a ‘hacktool’ Trojan as identified by the other Antivirus companies.
There are chances that this is another behavior that our sample also behaves like the sample mentioned below.
We find that the Mimikatz malware is related with the PowerShell.
We had found out the same PowerShell which we had reported in our previous blog.
Hence the Shamoon 2.0 has some behaviour with PowerShell.
Following screenshot shows the PowerShell commands that Shamoon 2.0 executes:From the evidence collected we confirm links between the Shamoon 1.0 to Shamoon 2.0.Some features that were observed with this sample are that it is using an overlay to hid the packer information:
Analysing further, we found out the MEW 10v1.0 from Northfox packer is used:
Unlike the components that we analyzed so far this particular sample had the CRC16 Hash function which is completely different.
The malware has a SSL certificate embedded within it.
The following screenshot gives the SLL certificate information,
The certificate is valid from Monday,January  11, 2010 7:49.26 PM to Friday, January 11 2013 7:49:26 PM
This above date correlates to the hard-coded date inside the program.
This hardcoded date allows the program to execute since the date is inside the validity period as mentioned.
The pseudo code explains that Shamoon 2.0 changes the system time, and sets it at random time and date between Monday, January  11, 2010 7:49.26 PM to Friday, January 11 2013 7:49:26 PM.
The above code is derived from this code flow:The reason for Shamoon 2.0 changes the time and date settings is because we found out that Shamoon 2.0 uses a commercial product which the malware developers are using which is as called RawDisk by EldoS Corporation.
This software gives direct access to files, disk and partitions.
The temporary license key for this product is between the time mentioned earlier and hence Shamoon 2.0 changes the system time to make the product believe into thinking that it is using a valid key, and thus the overwrite function can take place.
The MBR-Overwriting Techniques that Shamoon 2.0 Implements:Before explaining the MBR overwriting that the Shamoon 2.0 does we need to understand what is an MBR or the Master Boot Record (MBR).
MBR usually is the first 512 bytes of the disk which consists of all the important and crucial information about the data in the disk.
The breakdown of the 512 bytes is as shown below:The reason of overwriting the first 512 bytes of data is
 So, that in simple terms mean that target the MBR and lose all data rather than wiping the entire drive all-together.
The following screenshot is a pseudo-code for the MBR-overwrite method that the Shamoon 2.0 uses.As seen the code above there is a comparison of a variable with ‘69’.
The ASCII equivalent of 69 is ‘E’
So, the way the code works in 3 simple steps:
Reads the data from the location to overwrite.2.
Uses an XOR table to corrupt the data 3.
Write back the XOR’ed values to the location where it read the original data from.
This particular snippet shows how the IoDeleteDevice routine removes a device object from the system, once the MBR is overwritten.
Therefore, the drive is no longer visible on the system.
ConclusionFrom the whole analysis, we now can say the following behaviour.
The Shamoon sample that is currently spreading is not very different from what spread in its first attack of August 2012.
There is a lot of similarity in the previous sample and the new sample.
But the new sample is more destructive than the older one.
The modules which are split into Dropper, Communication, Wiper are independent and yet linked with one another.
From the analysis, we can say that the wiper component is the most important out of the three.
The first stage that the Shamoon 2.0 does it that it checks the system date and compares it with the date embedded.
If the date matches it proceeds towards the deletion stage but, otherwise Shamoon 2.0 changes the date into a date which is acceptable to the malware sample and then proceeds to the infection.
The wiper is does not only overwrites the MBR (Master-Boot-Record), but also uses the IODevices module to trigger alerts to the compromised system about the device module being removed from the system altogether making the system completely useless to the user.
The language detected as Arabic Yemen shows that it's a targeted attack towards Middle East.
 We have launched a Shamoon detection tool which can detect the new Shamoon 2.0.
How to Disable SMB on Windows Machines to prevent WannaCry Ransomwar
WannaCry Ransomware : Initial Analysis
Ransomware is emerging as a leading cybersecurity threat to both organisations and individuals.
How do you defend yourself against it?Download our Free eBook Now
We have 9 guests and no members online
Ransomware started hitting the digital world as an outbreak, soon after bitcoin became the talk of the town.Ransomware has exploited thousands and thousands of machines, devices, browsers, websites and applications so far and bagged tons and tons of money.
The exclusive online hub to know all and everything about Ransomware.
Getting smart and being with Vinransomware is the way ahead to protect your organisation from typical Ransomware related Malware attacks.
