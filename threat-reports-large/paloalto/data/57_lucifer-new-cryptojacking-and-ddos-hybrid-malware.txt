On May 29, 2020, Unit 42 researchers discovered a new variant of a hybrid cryptojacking malware from numerous incidents of CVE-2019-9081 exploitation in the wild.
A closer look revealed the malware, which we’ve dubbed “Lucifer”, is capable of conducting DDoS attacks and well-equipped with all kinds of exploits against vulnerable Windows hosts.
The first wave of the campaign stopped on June 10, 2020.
The attacker then resumed their campaign on June 11, 2020, spreading an upgraded version of the malware and wreaking havoc.
The sample was compiled on Thursday, June 11, 2020 10:39:47 PM UTC and caught by Palo Alto Networks Next-Generation Firewall.
At the time of writing, the campaign’s still ongoing.
Lucifer is quite powerful in its capabilities.
Not only is it capable of dropping XMRig for cryptojacking Monero, it’s also capable of command and control (C2) operation and self-propagation through the exploitation of multiple vulnerabilities and credential brute-forcing.
Additionally, it drops and runs EternalBlue, EternalRomance, and DoublePulsar backdoor against vulnerable targets for intranet infections.
The exhaustive list of weaponized exploits includes CVE-2014-6287, CVE-2018-1000861, CVE-2017-10271, ThinkPHP RCE vulnerabilities (CVE-2018-20062), CVE-2018-7600, CVE-2017-9791, CVE-2019-9081, PHPStudy Backdoor RCE, CVE-2017-0144, CVE-2017-0145, and CVE-2017-8464.
These vulnerabilities have either “high” or “critical” ratings due to their trivial-to-exploit nature and their tremendous impact inflicted on the victim.
Once exploited, the attacker can execute arbitrary commands on the vulnerable device.
In this case, the targets are Windows hosts on both the internet and intranet, given that the attacker is leveraging certutil utility in the payload for malware propagation.
Fortunately, the patches for these vulnerabilities are readily available.
While the vulnerabilities abused and attack tactics leveraged by this malware are nothing original, they once again deliver a message to all organizations, reminding them why it’s utterly important to keep systems up-to-date whenever possible, eliminate weak credentials, and have a layer of defenses for assurance.
At the time of writing this blog, the XMR wallet has paid 0.493527 XMR, which converts to approximately $32 USD.
Palo Alto Networks Next-Generation Firewalls can detect and block all the exploit attempts from this kind of malware family.
This blog includes a detailed analysis of Lucifer and the comparison of version 1 and version 2.
A quick note on the name: While the malware author named their malware Satan DDoS, there’s another malware, Satan Ransomware, bearing that devious name already.
An alternative alias was given to this malware to avoid confusion.
As a result of staying faithful to the unique strings in the binary, we are calling this Lucifer.
We identified two versions of Lucifer in our research – we focus first on version 1 and then highlight the changes made to version 2 in the following section.
Lucifer contains three resource sections, each of which contains a binary for a specific purpose.
The X86 resource section contains a UPX-packed x86 version of XMRig 5.5.0.
The X64 resource section contains a UPX-packed x64 version of XMRig 5.5.0.
The SMB section contains a binary, in which there’s a lot of Equation Group’s exploits like EternalBlue and EternalRomance, and of course the infamous DoublePulsar backdoor implant.
X86: 8edbcd63def33827bfd63bffce4a15ba83e88908f9ac9962f10431f571ba07a8
X64: Ac530d542a755ecce6a656ea6309717ec222c34d7e34c61792f3b350a8a29301
SMB: 5214f356f2e8640230e93a95633cd73945c38027b23e76bb5e617c71949f8994
Upon execution, the malware first decrypts its C2 IP address using a xor-incremental encryption and then creates a mutant, using its C2 IP address as the mutant’s name.
The decrypted C2 IP address is 122.112.179.189.
The name of the mutant object is \Sessions\1\BaseNamedObjects\122.112.179.189
The pseudo-code for the decryption algorithm is shown in the figure below.
The malware then proceeds to persist itself by setting the following registry key values.
HKCU\Software\Microsoft\Windows\CurrentVersion\Run\QQMusic – %malware binary path%
HKLM\Software\Microsoft\Windows\CurrentVersion\Run\QQMusic – %malware binary path%
The binary also uses schtasks to set up itself as a task running periodically, ensuring additional layer of persistence.
The command executed is shown in Figure 2.
Once the malware has persisted itself, it then checks whether there’s any existing stratum mining information stored in the following registry key value:
HKLM\Software\Microsoft\Windows\CurrentVersion\spreadCpuXmr – %stratum info%
The mining information stored in this registry key value takes precedence if the data is present and legit.
Otherwise, the malware falls back to its default data embedded in the binary.
The malware enables itself with debug privilege and starts several threads to carry out its operation in concurrent fashion.
The following table summarizes the function of each thread.
Table 1.
Worker Thread Description
The malware employs different propagation strategies.
The malware scans for both open TCP ports 135 (RPC) and 1433(MSSQL) against the target, be it internal or external, and probes for the credential weakness in attempt to gain unauthorized access.
If the target has the RPC port open, the malware brute-forces the login using the default username administrator and its embedded password list.
It then copies and runs the malware binary on the remote host upon successful authentication.
When the malware detects that the target has TCP port 1433 open, it tries to brute-force its way in using its embedded list of usernames and passwords.
Upon successful login, the malware then issues shell commands to download and execute a replica of itself on the victim.
The aforementioned list of usernames and passwords can be found in the appendix section.
In addition to brute-forcing the credentials, the malware leverages exploitation for self-propagation.
For intranet infection, it drops and runs EternalBlue, EternalRomance, and DoublePulsar backdoor against the target when the target has TCP port 445 (SMB) open.
Upon successful exploitation, certutil is used to propagate the malware.
The following figures show the parameters passed to launch the exploits and the backdoor implant.
In order to infect external hosts, the malware first generates a non-private IP address, and then probes this randomly-selected victim with HTTP requests over a number of ports.
The list of ports is available in the Appendix.
When the malware receives a valid HTTP response from the victim, it then tries to exploit the target based on the conditions shown in the following table.
