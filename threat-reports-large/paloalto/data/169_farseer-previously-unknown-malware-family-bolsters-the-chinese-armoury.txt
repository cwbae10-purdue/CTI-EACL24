Last year, Unit 42 wrote about a newly discovered espionage Android malware family, HenBox, which had countless features for spying on their victims – primarily the Uyghur population – including interaction with Xiaomi IoT devices, and the Chinese consumer electronics manufacturer’s smart phones.
Through investigations into infrastructure used by HenBox malware, Unit 42 has discovered another malware family built for the more frequently-targeted Microsoft Windows operating system we named ‘Farseer’.
As with HenBox, Farseer also has infrastructure ties to other malware, such as Poison Ivy and Zupdax.
We named this malware Farseer malware due to a string found in the PDB path embedded within the executable files.
For example:
e:\WorkSpace\A1\coding\Farseer\RemoteShellsRemote\Release\RemoteShellsRemote.pdb.
Tracking-back, we’ve seen over 30 unique samples throughout the past two and half years, with the majority in 2017 and a handful in 2018, the most recent of which were seen, at least from our visibility, during the last two months indicating a relatively low-volume yet steady flow of Farseer samples.
Figure 1 below shows the trend of malicious sessions for these samples according to AutoFocus.
Figure 1 AutoFocus session trends for Farseer samples over time
As previously mentioned, there are ties between Farseer, HenBox, PlugX, Zupdax, 9002, and Poison Ivy malware families.
The infrastructure used by the combination of malware families is pretty vast, with plenty of overlaps, however in this blog we focus only on some of the core ties captured in the green rectangle, as shown in Figure 2 below.
Figure 2 Maltego chart showing overlaps between Farseer and related threats
Figure 2 shows a high-level representation of file hashes, IP addresses, and domain names used by some of the various malware families already mentioned, together with their overlaps.
Farseer has the largest number of samples in Figure 2 but that’s skewed given the focus of this blog.
The green rectangle shows some of the core overlaps between the aforementioned families, which we will discuss in more detail now.
The most recent (at the point of publishing) Farseer sample (SHA256: 271E29FE… detailed in Table 2 below) introduced a new C2 domain – tcpdo.net – into the Farseer set, as shown in Figure 3 below.
Figure 3 Maltego diagram showing tcpdo.net and other Farseer / PoisonIvy overlaps.
Figure 3 shows how this new (to Farseer) domain relates both directly to said Farseer sample and indirectly, through third-level domains and IP addresses, to other Farseer samples; a handful of Poison Ivy samples have also used this domain as their C2, mostly before this Farseer sample – as early as mid-2015 – but also more recently, one month after, on December 17th, 2018 indicating it’s a domain in fairly active use.
Third-level domains of tcpdo.net, together with all other indicators are listed at the end of this blog.
The overlaps between Farseer and Poison Ivy don’t end with tcpdo.net.
Much like with HenBox, other infrastructure ties exist: directly through sony36.com and md.son36.com; indirectly through third-level domains of tcpdo.net and IP addresses 45.32.251.7 and 45.32.53.250.
Farseer also overlaps with HenBox and PlugX samples through multiple C2 domains and IP address resolutions:
outhmail.com (and third-levels of this domain)
cdncool.com (and third-levels of this domain)
www3.mefound.com
w3.changeip.org
www5.zyns.com
45.32.53.250
45.32.44.52
45.32.45.77
59.188.196.162
59.188.196.172
Domain outhmail.com was documented as part of research into a 9002 Trojan delivered through Google Drive back in 2016 further expanding the capabilities of this group and its tools.
Before we detail the Farseer malware itself, it’s worth noting another overlap we encountered during this research.
Third-level domain 3w.tcpdo.net, as shown towards the bottom of Figure 4 below, resolved to IP 175.45.192.234 in 2015.
This IP address relates to domains and custom Gh0st RAT malware samples, some of which are documented in this Ghost Dragon campaign report.
Considering the time that’s passed since this publication, it’s harder to investigate how strong the ties are, however, the two domains used by Poison Ivy (md5c.net) and Farseer (3w.tcpdo.net) have resolved to that IP address more recently than documented in the Ghost Dragon report.
Specifically, June 2015, and between July and August 2015, respectively for Poison Ivy and Farseer; these two domains and five others – adminloader.com, csip6.biz, cdncool.com, linkdatax.com and adminsysteminfo.com – have a common registrant, 46313@QQ.COM but no such commonality exists within the set of known Ghost Dragon domains.
It’s possible the infrastructure relates to the same group, or multiple groups, conducting various attacks against different operating systems using the various malware families described in this, and related, reports.
The possible ties require further investigation.
Figure 4 Maltego chart showing overlaps to Ghost Dragon campaign
As previously mentioned in the first HenBox blog, a common registrant registered seven known domains, four of which had malicious activity related to Poison Ivy and Zupdax malware families.
Interestingly, all of the domains share at least one third-level domain in common, perhaps indicating a template being used for the infrastructure setup or based on the requirements of the malware’s C2 communication.
Table 1 below lists the commonalities, aside from other domains such as www, mail and dns.
Table 1 Common third-level domain names
Now that we have introduced Farseer, and how it relates to other known malware families, let’s dive into how the malware works.
This section aims to provide a description of the general behavior for this malware based on a small subset of total set of samples; a more detailed description exists in the technical appendix.
Figure 5, below, describes at a high-level the post-installation execution flow of a typical Farseer sample.
Figure 5 Farseer Execution Flow
Farseer employs the known technique of DLL sideloading – the use of trusted binaries to load malicious code – to load its payload, see Figure 5.
To achieve this, the malware begins by dropping known, legitimate, signed binaries to the host.
These binaries, signed by Microsoft or other vendors, are typically trusted applications when checked by antivirus software or the operating system and thus do not raise any suspicious alerts.
Figure 6 below shows the import library list for both the benign PE files highlighting how the nested imports work to ultimately load sys.dll – the malicious payload.
Figure 6 bscmake.exe importing mspdb80.dll importing Farseer’s sys.dll
The payload on disk is an encrypted and compressed file that most antivirus software will not flag as malicious since the underlying code is hidden.
More information about how the decompression and decryption can be found in the appendix.
Once sys.dll is running, it locates a file named stub.bin located in the same folder, and in-turn loads the Farseer config file, sys.dat, on disk.
The config relates to C2 communications, amongst other things.
The following two code excerpts show the obfuscated and deobfuscated versions of this variant’s configuration file.
The obfuscation routine used in this case – and many others – is simply ASCII encoding where characters are replaced with their ASCII value; other variants have used stronger, custom encryption algorithms to hide configuration data.
Details are in the appendix.
The line items in the second code excerpt above are represented as follows:
p1 relates to the C2 FQDN;
p2 is the TCP port used for C2 – many variants use non-standard TCP ports;
p3 is missing;
p4 appears to be a version string of some sort, which is sent as part of the C2 communication – other variants have used strings, such as “mark”;
p5 is the full file path from where the malware was launched.
Farseer config files share some similarities with those of HenBox, as documented here and shown in Figure 7 below for convenience.
Figure 7 Screenshot of HenBox configuration file, setting.txt
Both are text files, read and parsed at run-time; more often than not, the ASCII data is obfuscated using encoding methods of varying sophistication.
Perhaps the most notable similarity is the notation of the content, which in both malware families:
is delimited by an ‘=’ equals character;
uses a single character followed by a single digit starting from 1 to begin each line;
has the C2 host/FQDN on the first line;
has the TCP port to use to connect the C2 on the second line;
For persistence on the host, the Farseer malware creates a registry entry named sys under:
HKCU\Software\Microsoft\Windows\CurrentVersion\Run
The entry runs the VBS script slmgr.vbs shown below, which executes bscmake.exe, and thus Farseer, each time a user logs on to their PC.
createobject(“wscript.shell”).run “C:\Users\[username]\AppData\Roaming\windows\bscmake.exe”
One of the earliest Farseer samples Unit 42 analysed also used a decoy PDF document during execution.
The PDF content included a copied news article from a Myanmar website that reports on news in the Southeast Asia region.
The file properties of said PDF, as shown below, describe the language setting of the application that created it, together with the creation date – eight days prior to the Farseer sample that used the document.
Language : zh-CN
Author : Administrator
Creator : Microsoft® Word 2013
Create Date : 2016:04:11 11:06:30+08:00
Modify Date : 2016:04:11 11:06:30+08:00
More information about this variant of Farseer, and the decoy PDF, can be found in the appendix section.
In this case, we do not have great visibility into the targets of the Farseer malware.
However, given our existing knowledge based on previous research, and around malware with closely-related infrastructure, together with certain targeting themes seen in some Farseer samples, it is highly likely that victims lay in and around the South East Asia region.
The threat actors behind Farseer, and related malware including HenBox, continue to grow their armoury with the addition of this previously-unknown malware family.
The overlapping infrastructure, shared TTPs and similarities in malicious code and configurations highlights the web of threats used to target victims in and around the South East Asia region and perhaps beyond.
Farseer payloads are backdoors that beacon to pre-configured C2 servers for instructions.
The malware uses various techniques to evade detection and inhibit analysis.
For example, DLL sideloading using trusted, signed executables allows the malware to execute rather seamlessly; some payloads are encrypted on disk preventing analysis, especially as decompression and decryption occurs at runtime, in-memory, where code is further altered to thwart forensic analysis.
Whereas HenBox posed a threat for devices running Android, Farseer is built to target Windows, which appears to be more typical given previous threats seen from the group or groups behind this, and related malware.
Palo Alto Networks customers are already protected via:
All samples in this report have a malicious verdict in WildFire.
Traps advanced endpoint protection detects Farseer malware.
Domains have been classified as malicious.
AutoFocus tags are available for additional context: Farseer.
Update 18th September 2019: This blog has changed to remove two references to PKPLUG as a malware family.
The technical analysis of Farseer malware is described in this section.
Table 2 below lists the samples we have chosen for our investigation.
The list includes a couple of recent samples and the first Farseer sample seen, according to our data, to highlight key differences in the threat’s evolution.
